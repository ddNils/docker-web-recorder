name: Test RTMP Stream

on:
  push:
    branches:
      - main
  pull_request:

env:
  STREAM_ID: test_stream

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      nginx:
        image: alfg/nginx-rtmp:latest
        ports:
          - 1935/tcp
          - 80/tcp

    steps:
      - uses: actions/checkout@v6

      - uses: docker/setup-buildx-action@v3

      - uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: docker-web-recorder:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker

      - name: Wait for nginx-rtmp to be ready
        shell: bash
        run: |
          timeout=30
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -f http://localhost:${{ job.services.nginx.ports['80'] }}/stat > /dev/null 2>&1; then
              echo "nginx-rtmp is ready"
              exit 0
            fi
            echo "Waiting for nginx-rtmp... ($elapsed/$timeout seconds)"
            sleep 2
            elapsed=$((elapsed + 2))
          done
          echo "nginx-rtmp failed to start"
          exit 1

      - name: Start recorder container
        shell: bash
        run: |
          docker run -d \
            --name web-recorder \
            --network host \
            -e OUTPUT=rtmp://localhost:${{ job.services.nginx.ports['1935'] }}/stream/${{ env.STREAM_ID }} \
            -e URL=https://httpbin.org \
            -e RESOLUTION=1280x720 \
            -e RATE=1000 \
            docker-web-recorder:test

      - name: Monitor stream
        shell: bash
        run: |
          echo "Waiting for stream to start..."
          sleep 2

          for i in {1..15}; do
            echo "Checking stream status (attempt $i/5)..."
            stat_response=$(curl -s http://localhost:${{ job.services.nginx.ports['80'] }}/stat || echo "")
            
            if echo "$stat_response" | grep -q "${{ env.STREAM_ID }}"; then
              echo "Stream detected in nginx-rtmp stats!"
              echo "$stat_response"
              exit 0
            fi
            
            sleep 1
          done

          echo "Stream not detected in nginx-rtmp stats"
          echo "nginx-rtmp stats:"
          curl -s http://localhost:${{ job.services.nginx.ports['80'] }}/stat || echo "Failed to get stats"
          exit 1

      - name: Check container logs
        if: always()
        shell: bash
        run: |
          echo "=== Container logs ==="
          docker logs web-recorder || echo "Failed to get logs"

      - name: Cleanup
        if: always()
        shell: bash
        run: |
          docker stop web-recorder || true
          docker rm web-recorder || true
